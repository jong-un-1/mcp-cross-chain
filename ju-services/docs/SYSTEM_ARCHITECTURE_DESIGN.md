# Cross-Chain DEX Architecture Design Document

## 1. 系统概述

基于提供的架构图，这是一个多链去中心化交易所（DEX）系统，包含5个核心微服务组件，负责不同的业务职责。系统采用事件驱动架构，支持跨链流动性管理和自动化交易执行。

## 2. 核心组件架构

### 2.1 Keeper（调度服务）
**职责**: 系统调度与自动化执行
- **定时任务执行**: 按预设间隔运行关键业务流程
- **流动性再平衡**: 监控并自动调整跨链流动性分布
- **订单处理**: 检查待处理订单并触发执行流程
- **Lit Actions触发**: 启动Lit协议的智能操作

**技术实现**:
- 基于 Cloudflare Workers 的 Cron Jobs
- 与 Lit Network 集成执行跨链操作
- 使用队列机制确保任务可靠执行

### 2.2 Funder（资金管理服务）
**职责**: 智能合约资金管理
- **地址资金监控**: 跟踪 Lit Actions 控制的地址余额
- **资金配置管理**: 设置最低门槛等资金参数
- **ETH/SOL资金投入**: 向区块链网络注入流动性
- **permit2data构建**: 为ERC20代币构建授权数据

**技术实现**:
- 集成多链 RPC 节点（ETH、SOL等）
- 实时余额监控和阈值报警
- 自动化资金重分配算法

### 2.3 Indexer（数据索引服务）  
**职责**: 区块链数据聚合与存储
- **多链数据监听**: 持续连接支持的区块链网络
- **事件数据采集**: 监听相关智能合约事件
- **状态查询**: 定期查询智能合约状态变化
- **数据持久化**: 将链上数据存储到 SQL 数据库
- **指标提取**: 从原始数据中提取业务指标
- **用户余额跟踪**: 维护用户资产状态

**技术实现**:
- WebSocket 连接多个区块链节点
- Redis 缓存热点数据
- 分布式数据库存储历史记录

### 2.4 Watcher（监控服务）
**职责**: 系统监控与数据分析
- **指标追踪**: 监控系统运行时指标
- **数据发布**: 将指标数据推送到 Prometheus
- **订单数据提取**: 分析交易订单相关数据
- **协议量监控**: 跟踪协议交易量变化
- **编排器统计**: 监控资产余额和使用情况

**技术实现**:
- Prometheus 指标收集
- 实时数据流处理
- 自定义仪表板和告警

### 2.5 Quoter（报价服务）
**职责**: 价格发现与交易执行
- **订单费用计算**: 计算交易手续费
- **代币价格获取**: 从多个数据源获取实时价格
- **交换金额计算**: 计算预期交易结果
- **流动性验证**: 确保有足够流动性完成订单
- **交易数据生成**: 为订单生成必要的交易数据
- **交换金额估算**: 提供交易前的金额预估
- **综合操作**: 整合所有因素生成最终报价

**技术实现**:
- 集成 Codex、Tenderly、Ethers 等价格源
- 多源价格聚合算法
- 实时流动性池状态监控

## 3. 数据流架构

### 3.1 外部数据源
- **Lit Network**: 执行跨链智能操作
- **区块链网络**: ETH、SOL等多链数据源
- **SQL Database + Redis**: 数据存储与缓存
- **Prometheus**: 监控数据收集
- **价格数据源**: Codex、Tenderly、Ethers

### 3.2 数据流向
1. **Blockchain → Indexer**: 事件数据和合约状态
2. **Indexer → Database**: 持久化存储链上数据
3. **Watcher → Prometheus**: 监控指标推送
4. **External APIs → Quoter**: 价格和Gas数据
5. **Keeper → Lit Network**: 执行跨链操作

## 4. 关键设计原则

### 4.1 微服务架构
- 每个组件职责单一明确
- 服务间通过标准API通信
- 独立部署和扩展

### 4.2 事件驱动
- 基于区块链事件的反应式处理
- 异步消息传递机制
- 解耦服务依赖关系

### 4.3 多链支持
- 统一的跨链接口抽象
- 链特定的适配器实现
- 可扩展的链集成框架

### 4.4 高可用性
- 服务冗余和故障转移
- 数据备份和恢复机制
- 监控和自动修复

## 5. 安全考虑

### 5.1 资金安全
- 多重签名钱包管理
- 资金操作权限控制
- 实时风险监控

### 5.2 数据完整性  
- 区块链数据验证
- 重复数据检测
- 数据同步一致性

### 5.3 系统安全
- API访问控制
- 加密通信协议
- 安全审计日志

## 6. 性能优化

### 6.1 缓存策略
- Redis热点数据缓存
- 智能缓存失效机制
- 分层缓存架构

### 6.2 数据处理
- 批量数据处理
- 异步任务队列
- 数据预聚合

### 6.3 网络优化
- CDN内容分发
- API响应压缩
- 连接池管理

## 7. 扩展性设计

### 7.1 水平扩展
- 无状态服务设计
- 负载均衡配置
- 动态扩容机制

### 7.2 功能扩展
- 插件化架构
- 新链集成接口
- 功能模块化

### 7.3 数据扩展
- 分片数据库设计
- 读写分离架构
- 数据归档策略